Turbo Assembler	 Version 4.1	    03/03/20 17:17:39	    Page 1
keyboa~1.asm



      1	0000			     .model tiny
      2	0000			     .data
      3	0000  00000000		     sysHandler	 dd 0
      4	0004  149A		     freqE	 dw 5274d
      5	0006  105A		     freqC	 dw 4186d
      6	0008  125A		     freqD	 dw 4698d
      7	000A  00		     scanCode	 db 0
      8
      9	000B			     .code
     10				     org 100h
     11
     12	0100			     Start:
     13	0100  B4 35				 mov ah, 35h
     14	0102  B0 09				 mov al, 09h
     15	0104  CD 21				 int 21h
     16	0106  89 1E 0000r			 mov word ptr sysHandler, bx
     17	010A  8C 06 0002r			 mov word ptr sysHandler + 2, es
     18
     19	010E  B4 25				 mov ah, 25h
     20	0110  B0 09				 mov al, 09h
     21	0112  BA 011Fr				 mov dx, offset	NewKeyboardInt
     22	0115  CD 21				 int 21h
     23
     24	0117  B8 3100				 mov ax, 3100h
     25	011A  BA 018Er				 mov dx, offset	EndInt
     26	011D  CD 21				 int 21h
     27
     28				     ;=============================================================
     29				     ;My keyboard interrupt
     30				     ;
     31				     ;=============================================================
     32	011F			     NewKeyboardInt proc
     33	011F  9C				 pushf
     34	0120  2E: FF 1E	0000r			 call cs:sysHandler
     35	0125  50 57 06				 push ax di es
     36
     37	0128  E4 60				 in al,	60h
     38	012A  80 06 000Ar 80			 add scanCode, 128d
     39	012F  3A 06 000Ar			 cmp al, scanCode
     40	0133  74 3F				 je @@SoundOff
     41	0135  A2 000Ar				 mov scanCode, al
     42
     43						 ;расчёт коэффициента	деления:	c = 1193180 Гц / f
     44	0138  B8 34DC				 mov ax,34dch  ;dx:ax =	1193180
     45	013B  BA 0012				 mov dx,12h
     46
     47	013E  80 3E 000Ar 12			 cmp scanCode, 12h
     48	0143  74 0A				 je @@noteE
     49
     50	0145  80 3E 000Ar 2E			 cmp scanCode, 2eh
     51	014A  74 0A				 je @@noteC
     52
     53						 ; cmp scanCode, 20h
     54						 ; je @@noteD
     55
     56	014C  EB 2C 90				 jmp @@exit
     57
Turbo Assembler	 Version 4.1	    03/03/20 17:17:39	    Page 2
keyboa~1.asm



     58	014F  F7 36 0004r	     @@noteE:	 div freqE
     59	0153  EB 08 90				 jmp @@setTimer
     60
     61	0156  F7 36 0006r	     @@noteC:	 div freqC
     62	015A  EB 01 90				 jmp @@setTimer
     63
     64				     ; @@noteD:	   div freqD
     65						 ; jmp @@setTimer
     66
     67	015D  8B D0		     @@setTimer: mov dx, ax
     68	015F  B0 B6				 mov al, 0b6h
     69	0161  E6 43				 out 43h, al
     70	0163  8A C2				 mov al, dl
     71	0165  E6 42				 out 42h, al
     72	0167  8A C6				 mov al, dh
     73	0169  E6 42				 out 42h, al
     74
     75	016B  E4 61		     @@SoundOn:	 in al,	61h
     76	016D  0C 03				 or al,	3
     77	016F  E6 61				 out 61h, al
     78	0171  EB 07 90				 jmp @@exit
     79
     80	0174  E4 61		     @@SoundOff: in al,	61h
     81	0176  24 02				 and al, 2
     82	0178  E6 61				 out 61h, al
     83
     84	017A  E4 61		     @@exit:	 in al,	61h
     85	017C  8A E0				 mov ah, al
     86	017E  0C 80				 or al,	80h
     87	0180  E6 61				 out 61h, al
     88	0182  86 E0				 xchg ah, al
     89	0184  E6 61				 out 61h, al
     90
     91	0186  B0 20				 mov al, 20h
     92	0188  E6 20				 out 20h, al
     93
     94	018A  07 5F 58				 pop es	di ax
     95	018D  CF				 iret
     96	018E					 endp
     97	018E			     EndInt:
     98
     99				     ;===========================================================
    100				     ;Draw frame on screen
    101				     ;Entry:
    102				     ;cx - num repiats of central elements
    103				     ;bx - left	up corner (bl -	x, bh -	y)
    104				     ;dl - num of rows
    105				     ;Destr: cx, dx, ax, es, di, bx
    106				     ;===========================================================
    107
    108	018E			     Frame	 proc
    109	018E  51				 push cx
    110
    111	018F  B8 B800					     mov ax, 0b800h
    112	0192  8E C0					     mov es, ax
    113
    114	0194  B0 A0					     mov al, 80d*2
Turbo Assembler	 Version 4.1	    03/03/20 17:17:39	    Page 3
keyboa~1.asm



    115	0196  F6 E7					     mul bh
    116	0198  8A CB					     mov cl, bl
    117	019A  02 CB					     add cl, bl
    118	019C  03 C1					     add ax, cx
    119	019E  8B F8				 mov di, ax
    120
    121	01A0  59					     pop cx
    122	01A1  51					     push cx
    123
    124	01A2  B0 C9				 mov al, 0c9h
    125	01A4  B4 5E				 mov ah, 05eh
    126	01A6  AB				 stosw
    127
    128	01A7  B0 CD				 mov al, 0cdh
    129	01A9  F3> AB				 rep stosw
    130
    131	01AB  B0 BB				 mov al, 0bbh
    132	01AD  AB				 stosw
    133
    134
    135	01AE  B6 00				 mov dh, 0
    136
    137	01B0  59		     @@Center:	     pop cx
    138	01B1  51				 push cx
    139
    140	01B2  2B F9					     sub di, cx
    141	01B4  2B F9					     sub di, cx
    142	01B6  83 EF 04					     sub di, 4
    143	01B9  81 C7 00A0				     add di, 80d*2
    144
    145	01BD  B0 BA				 mov al, 0bah
    146	01BF  B4 5E				 mov ah, 05eh
    147	01C1  AB				 stosw
    148
    149	01C2  B0 00				 mov al, 0
    150	01C4  F3> AB				 rep stosw
    151
    152	01C6  B0 BA				 mov al, 0bah
    153	01C8  AB				 stosw
    154
    155	01C9  FE C6				 inc dh
    156	01CB  3A F2				 cmp dh, dl
    157	01CD  72 E1				 jb @@Center
    158
    159
    160	01CF  59				 pop cx
    161
    162	01D0  2B F9				 sub di, cx
    163	01D2  2B F9					     sub di, cx
    164	01D4  83 EF 04					     sub di, 4
    165	01D7  81 C7 00A0				     add di, 80d*2
    166
    167	01DB  B0 C8				 mov al, 0c8h
    168	01DD  B4 5E				 mov ah, 05eh
    169	01DF  AB				 stosw
    170
    171	01E0  B0 CD				 mov al, 0cdh
Turbo Assembler	 Version 4.1	    03/03/20 17:17:39	    Page 4
keyboa~1.asm



    172	01E2  F3> AB				 rep stosw
    173
    174	01E4  B0 BC				 mov al, 0bch
    175	01E6  AB				 stosw
    176
    177
    178	01E7  C3				 ret
    179	01E8					 endp
    180
    181				     end Start
Turbo Assembler	 Version 4.1	    03/03/20 17:17:39	    Page 5
Symbol Table




Symbol Name			  Type	 Value

??DATE				  Text	 "03/03/20"
??FILENAME			  Text	 "keyboa~1"
??TIME				  Text	 "17:17:39"
??VERSION			  Number 040A
@32BIT				  Text	 0
@@CENTER			  Near	 DGROUP:01B0
@@EXIT				  Near	 DGROUP:017A
@@NOTEC				  Near	 DGROUP:0156
@@NOTEE				  Near	 DGROUP:014F
@@SETTIMER			  Near	 DGROUP:015D
@@SOUNDOFF			  Near	 DGROUP:0174
@@SOUNDON			  Near	 DGROUP:016B
@CODE				  Text	 DGROUP
@CODESIZE			  Text	 0
@CPU				  Text	 0101H
@CURSEG				  Text	 _TEXT
@DATA				  Text	 DGROUP
@DATASIZE			  Text	 0
@FILENAME			  Text	 KEYBOA~1
@INTERFACE			  Text	 000H
@MODEL				  Text	 1
@STACK				  Text	 DGROUP
@WORDSIZE			  Text	 2
ENDINT				  Near	 DGROUP:018E
FRAME				  Near	 DGROUP:018E
FREQC				  Word	 DGROUP:0006
FREQD				  Word	 DGROUP:0008
FREQE				  Word	 DGROUP:0004
NEWKEYBOARDINT			  Near	 DGROUP:011F
SCANCODE			  Byte	 DGROUP:000A
START				  Near	 DGROUP:0100
SYSHANDLER			  Dword	 DGROUP:0000

Groups & Segments		  Bit Size Align  Combine Class

DGROUP				  Group
  _DATA				  16  000B Word	  Public  DATA
  _TEXT				  16  01E8 Word	  Public  CODE
